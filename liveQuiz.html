
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>User Panel ‚Äì SSC Quiz</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            /* body{font-family:Arial;background:#0f172a;color:white;}
            .box{width:500px;margin:30px auto;background:#1e293b;padding:20px;border-radius:10px;}
            input,button{width:100%;padding:10px;margin:6px 0;border:none;border-radius:5px;}
            button{background:#334155;color:white;cursor:pointer}
            button:hover{background:#475569}
            .option-selected{background:#22c55e!important}
            #startBox,#quizBox,#resultBox{display:none} */

/* BASE */
*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0f172a;
  color:white;
}

/* MAIN BOX */
.box{
  width:95%;
  max-width:500px;
  margin:20px auto;
  background:#1e293b;
  padding:16px;
  border-radius:12px;
}

/* HEADINGS */
h2{
  text-align:center;
  font-size:22px;
  margin-bottom:10px;
}
h3{
  font-size:18px;
  margin-bottom:6px;
}

/* INPUT + BUTTON */
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border:none;
  border-radius:8px;
  font-size:15px;
}

input{
  background:#020617;
  color:white;
  border:1px solid #334155;
}

button{
  background:#334155;
  color:white;
  cursor:pointer;
}

button:hover{
  background:#475569;
}

/* QUIZ OPTIONS */
#options button{
  margin:6px 0;
  font-size:15px;
}

/* SELECTED OPTION */
.option-selected{
  background:#22c55e!important;
  color:#020617;
  font-weight:bold;
}

/* HIDE SECTIONS */
#startBox,#quizBox,#resultBox{
  display:none;
}

/* INFO TEXT */
p{
  font-size:14px;
  margin:6px 0;
}

/* RESULT */
#scoreText{
  line-height:1.6;
  font-size:15px;
}

/* MOBILE EXTRA SMALL */
@media (max-width:400px){
  h2{font-size:20px;}
  h3{font-size:16px;}
  input,button{font-size:14px;padding:10px;}
}


        </style>
    </head>
    <body>

        <div class="box">
            <h2>üî• SSC LIVE QUIZ</h2>
            <div id="authBox">

                <div id="signUpDiv">
                    <h3>Sign Up</h3>
                    <input id="suName" placeholder="Name">
                    <input id="suEmail" placeholder="Email">
                    <input id="suPass" type="password" placeholder="Password">
                    <button onclick="signUp()">Sign Up</button>
                    <p onclick="showSignIn()" style="cursor:pointer;color:#38bdf8">
                        Already have ID? Sign In
                    </p>
                </div>

                <div id="signInDiv" style="display:none">
                    <h3>Sign In</h3>
                    <!-- <input id="siId" placeholder="User ID"> -->
                     <input id="siId"
                    placeholder="User ID"
                    inputmode="numeric"
                    autocomplete="off"
                    autocapitalize="off"
                    autocorrect="off">

                    <input id="siPass" type="password" placeholder="Password">
                    <button onclick="signIn()">Sign In</button>
                    <p onclick="showSignUp()" style="cursor:pointer;color:#38bdf8">
                        Create new User ID
                    </p>
                </div>

            </div>

            <!-- START -->
            <div id="startBox">
                <p>üë§ <span id="userShow"></span></p>
                <p>üë• Live Users: <span id="liveCount">0</span></p>
                <!-- <p>üìò Quiz ID: <b>ssc001</b></p> -->
                <p>üìÖ Date: <span id="quizDate">--</span></p>
                <p>üïí Time: <span id="quizTime">--</span></p>
                <p>Status: <b><span id="quizStatus">--</span></b></p>
                <p>‚è± Time Left: <span id="timeLeft">--:--</span></p>
                <button onclick="startQuiz()">Start Quiz</button>
            </div>

            <!-- QUIZ -->
            <div id="quizBox">
                <h3 id="question"></h3>
                <div id="options"></div>
                <button id="nextBtn" onclick="nextQ()" disabled>Next</button>
            </div>

            <!-- RESULT -->
            <div id="resultBox">
                <h3 id="scoreText"></h3>
            </div>

        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        import { onSnapshot, deleteDoc } from
        "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


        import {
            getFirestore, doc, collection, setDoc,
            getDoc, getDocs, query, where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        /* FIREBASE */
        const firebaseConfig={
            apiKey:"AIzaSyA9jEFAe9gyM4Y8ijNq3I9UXfnpwTakrPc",
            authDomain:"mystorage-c9eeb.firebaseapp.com",
            projectId:"mystorage-c9eeb",
            storageBucket:"mystorage-c9eeb.appspot.com",
            messagingSenderId:"312232487382",
            appId:"1:312232487382:web:bf7d8c563030d0e682dc77"
        };

        const app = initializeApp(firebaseConfig);
        const db  = getFirestore(app);
        const auth= getAuth();

        /* üî• FIXED QUIZ ID */
        const quizId = "ssc";



        /* GLOBAL */
        let uid="", username="", email="";
        let questions=[], index=0, score=0, selected=null;
        let startTime=0, endTime=0, timerInt=null;

        /* UI TOGGLE */
        window.showSignUp=()=>{
            signUpDiv.style.display="block";
            signInDiv.style.display="none";
        }
        window.showSignIn=()=>{
            signUpDiv.style.display="none";
            signInDiv.style.display="block";
        }

        /* SIGN UP */
        // window.signUp = async ()=>{
        //     const cred = await createUserWithEmailAndPassword(
        //     auth,suEmail.value,suPass.value
        // );
        // uid = cred.user.uid;
        // username = suName.value;
        // email = suEmail.value;

        // let userId;
        // while(true){
        //     userId = Math.floor(100000+Math.random()*900000).toString();
        //     if(!(await getDoc(doc(db,"users",userId))).exists()) break;
        // }

        // await setDoc(doc(db,"users",userId),{uid,username,email});
        //     alert("Your User ID: "+userId);
        //     showStart();
        // };

        window.signUp = async () => {
  try {
    const cred = await createUserWithEmailAndPassword(
      auth,
      suEmail.value,
      suPass.value
    );

    uid = cred.user.uid;
    username = suName.value;
    email = suEmail.value;

    let userId;
    while (true) {
      userId = Math.floor(100000 + Math.random() * 900000).toString();
      if (!(await getDoc(doc(db, "users", userId))).exists()) break;
    }

    await setDoc(doc(db, "users", userId), {
      uid,
      username,
      email
    });

    alert("Your User ID: " + userId);
    showStart();

  } catch (error) {
    if (error.code === "auth/email-already-in-use") {
      alert("‚ùå Ye email pehle se register hai. Sign In karo.");
      showSignIn();
    } else {
      alert(error.message);
    }
  }
};


        /* SIGN IN */
        // window.signIn = async ()=>{
        //     const snap = await getDoc(doc(db,"users",siId.value));
        //     if(!snap.exists()) return alert("Invalid User ID");

        //     uid = snap.data().uid;
        //     username = snap.data().username;
        //     email = snap.data().email;

        //     await signInWithEmailAndPassword(auth,email,siPass.value);
        //     showStart();
        // };

        window.signIn = async () => {
  try {
    const userId = siId.value.trim();
    const password = siPass.value;

    if (!userId || !password) {
      alert("User ID aur Password dono bharo");
      return;
    }

    const snap = await getDoc(doc(db, "users", userId));
    if (!snap.exists()) {
      alert("Invalid User ID");
      return;
    }

    uid = snap.data().uid;
    username = snap.data().username;
    email = snap.data().email;

    await signInWithEmailAndPassword(auth, email, password);
    showStart();

  } catch (error) {
    alert("Login failed: " + error.message);
  }
};


        /* SHOW START + LOAD ADMIN TIME */
        async function showStart(){
            authBox.style.display="none";
            startBox.style.display="block";
            userShow.innerText = username;

            const snap = await getDoc(doc(db,"quizControl",quizId));
            if(!snap.exists()){
                quizStatus.innerText="Quiz Not Found";
                return;
            }

            startTime = snap.data().startTime;
            endTime   = snap.data().endTime;

            quizDate.innerText = new Date(startTime).toLocaleDateString("en-IN");

            quizTime.innerText =
            new Date(startTime).toLocaleTimeString("en-IN",{hour:'2-digit',minute:'2-digit'})
            +" - "+
            new Date(endTime).toLocaleTimeString("en-IN",{hour:'2-digit',minute:'2-digit'});

            // üë• LIVE USERS COUNT
            onSnapshot(collection(db,"liveUsers"),snap=>{
                let c = 0;
                snap.forEach(d=>{
                    if(d.data().quizId === quizId) c++;
                });
                liveCount.innerText = c;
            });
            startCountdown();
        }

        /* COUNTDOWN */
        function startCountdown(){
            timerInt = setInterval(()=>{
                const now = Date.now();

                if(now < startTime){
                    quizStatus.innerText="Not Started";
                    timeLeft.innerText="Waiting";
                }
                else if(now <= endTime){
                    quizStatus.innerText="Running";
                    const r = Math.floor((endTime-now)/1000);
                    timeLeft.innerText =`${Math.floor(r/60)}:${(r%60).toString().padStart(2,"0")}`;
                }
                else{
                    quizStatus.innerText="Ended";
                    timeLeft.innerText="00:00";
                    clearInterval(timerInt);
                }
            },1000);
        }

        /* START QUIZ */

        window.startQuiz = async ()=>{
            if(Date.now()<startTime || Date.now()>endTime)
            return alert("Quiz not running");

            startBox.style.display="none";
            quizBox.style.display="block";

            index = 0;
            score = 0;
            selected = null;

            // üîí check already attempted
            const already = await getDoc(doc(db,"results",uid+"_"+quizId));
            if(already.exists()){
                alert("You already attempted this quiz");
                return;
            }

            // üë• add live user
            await setDoc(doc(db,"liveUsers",uid),{
                quizId,
                userId: uid,
                username
            });


            const q = query(
                collection(db,"questions"),
                where("quizId","==",quizId) // ‚úÖ SAME QUIZ ID
            );

            const snap = await getDocs(q);
            questions = [];

            snap.forEach(d => questions.push(d.data()));

            if(questions.length === 0){
                alert("No questions found for quizId: "+quizId);
                quizBox.style.display="none";
                startBox.style.display="block";
                return;
            }

            loadQ();
        };


        /* QUESTIONS */
        function loadQ(){
            if(index >= questions.length){
                finish();
                return;
            }

            const q = questions[index];

            if(!q || !q.q){
                alert("Invalid question data");
                finish();
                return;
            }

            question.innerText = q.q;
            options.innerHTML="";

            q.o.forEach((x,i)=>{
                const b=document.createElement("button");
                b.innerText=x;
                b.onclick=()=>select(i,b);
                options.appendChild(b);
            });

            nextBtn.disabled=true;
        }


        window.select=(i,b)=>{
            selected=i;
            document.querySelectorAll("#options button")
            .forEach(x=>x.classList.remove("option-selected"));
            b.classList.add("option-selected");
            nextBtn.disabled=false;
        };

        window.nextQ=()=>{
            if(selected===questions[index].a) score+=10;
            index++; selected=null;
            index<questions.length ? loadQ() : finish();
        };

        /* FINISH */
        async function finish(){
            // remove live user
            await deleteDoc(doc(db,"liveUsers",uid));

            quizBox.style.display="none";
            resultBox.style.display="block";

            // save result
            await setDoc(doc(db,"results",uid+"_"+quizId),{
                quizId,
                username,
                userId: uid,
                email,
                score
            });

            // get all results for this quiz
            const snap = await getDocs(query(collection(db,"results"), where("quizId","==",quizId)));
            let arr = [];
            snap.forEach(d => arr.push(d.data()));

            // sort by score descending
            arr.sort((a,b) => b.score - a.score);

            // your rank
            const rank = arr.findIndex(x => x.userId === uid) + 1;

            // topper info (first element after sorting)
            const topper = arr[0];
  
            scoreText.innerHTML = `
                üë§ Your Name: <b>${username}</b><br>
                üèÜ Topper: <b>${topper.username}</b><br>
                Score: <b>${score}</b><br>
                Rank: <b>${rank}</b>
            `;
        }
        </script>
    </body>
</html> 
