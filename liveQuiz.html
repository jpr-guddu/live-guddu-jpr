<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Quiz ‚Äì JPR Guddu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- GOOGLE FONT -->
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

<!-- FIREBASE v9 COMPAT (NO MODULE) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
body{margin:0;font-family:Poppins;background:#0f172a;color:white}
.hide{display:none}
.box{max-width:520px;margin:20px auto;background:#1e293b;padding:15px;border-radius:12px}
button,input{width:100%;padding:10px;margin:6px 0;border:none;border-radius:6px}
button{background:#2563eb;color:white;cursor:pointer}
button:hover{background:#1d4ed8}
.liveCard{background:#1e293b;padding:12px;border-radius:10px;margin:10px}
.status-live{color:#22c55e}
.status-ended{color:#ef4444}
.option-selected{background:#22c55e!important;color:black}
</style>
</head>

<body>

<!-- ================= LIVE TEST LIST ================= -->
<div id="listBox">
  <h2 style="text-align:center">üî• Live Tests</h2>
  <div id="liveList"></div>
</div>

<!-- ================= AUTH ================= -->
<div class="box hide" id="authBox">
  <h3>Sign In</h3>
  <input id="email" placeholder="Email">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- ================= START ================= -->
<div class="box hide" id="startBox">
  <p>üë§ <span id="userName"></span></p>
  <p>Status: <b id="quizStatus"></b></p>
  <p>‚è± Time Left: <span id="timeLeft"></span></p>
  <button onclick="startQuiz()">Start Quiz</button>
</div>

<!-- ================= QUIZ ================= -->
<div class="box hide" id="quizBox">
  <h3 id="question"></h3>
  <div id="options"></div>
  <button onclick="nextQ()" id="nextBtn" disabled>Next</button>
</div>

<!-- ================= RESULT ================= -->
<div class="box hide" id="resultBox">
  <h3 id="resultText"></h3>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyA9jEFAe9gyM4Y8ijNq3I9UXfnpwTakrPc",
  authDomain:"mystorage-c9eeb.firebaseapp.com",
  projectId:"mystorage-c9eeb"
});
const db=firebase.firestore();
const auth=firebase.auth();

/* ================= GLOBAL ================= */
let quizId=null, questions=[], index=0, score=0, selected=null;
let startTime=0,endTime=0,timer=null;

/* ================= LOAD LIVE TESTS ================= */
db.collection("liveQuiz").get().then(s=>{
  const box=document.getElementById("liveList");
  s.forEach(d=>{
    const qc=d.data().quizControl||{};
    const div=document.createElement("div");
    div.className="liveCard";
    div.innerHTML=`
      <b>${d.id}</b><br>
      <span class="${qc.active?'status-live':'status-ended'}">
        ${qc.active?'LIVE':'ENDED'}
      </span><br><br>
      <button>Join</button>
    `;
    div.querySelector("button").onclick=()=>{
      if(!qc.active){alert("Quiz not live");return;}
      quizId=d.id;
      startTime=qc.startTime;
      endTime=qc.endTime;
      document.getElementById("listBox").classList.add("hide");
      document.getElementById("authBox").classList.remove("hide");
    };
    box.appendChild(div);
  });
});

/* ================= LOGIN ================= */
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .then(r=>{
    userName.innerText=r.user.email;
    authBox.classList.add("hide");
    startBox.classList.remove("hide");
    startCountdown();
  }).catch(e=>alert(e.message));
}

/* ================= COUNTDOWN ================= */
function startCountdown(){
  timer=setInterval(()=>{
    const now=Date.now();
    if(now>endTime){
      quizStatus.innerText="Ended";
      timeLeft.innerText="00:00";
      clearInterval(timer);
    }else{
      quizStatus.innerText="Running";
      const s=Math.floor((endTime-now)/1000);
      timeLeft.innerText=Math.floor(s/60)+":"+String(s%60).padStart(2,"0");
    }
  },1000);
}

/* ================= START QUIZ ================= */
function startQuiz(){
  startBox.classList.add("hide");
  quizBox.classList.remove("hide");

  db.collection("liveQuiz").doc(quizId).collection("questions").get()
  .then(s=>{
    questions=[];
    s.forEach(d=>questions.push(d.data()));
    loadQ();
  });
}

/* ================= QUESTIONS ================= */
function loadQ(){
  if(index>=questions.length){finish();return;}
  const q=questions[index];
  question.innerText=q.question;
  options.innerHTML="";
  q.o.forEach((x,i)=>{
    const b=document.createElement("button");
    b.innerText=x;
    b.onclick=()=>{selected=i;nextBtn.disabled=false;b.classList.add("option-selected");};
    options.appendChild(b);
  });
  nextBtn.disabled=true;
}

function nextQ(){
  if(selected===questions[index].answer)score++;
  index++;selected=null;
  loadQ();
}

/* ================= FINISH ================= */
function finish(){
  quizBox.classList.add("hide");
  resultBox.classList.remove("hide");
  resultText.innerText=`üéâ Score: ${score}/${questions.length}`;
}
</script>

</body>
</html>
